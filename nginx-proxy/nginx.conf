worker_processes auto;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

# Environment variables
env GO_AUTH_SERVICE_URL;
env AUTH_CONFIG_FILE;
env GO_NFT_PROXY_SOCKET;

http {
    resolver 1.1.1.1 8.8.8.8 valid=300s ipv6=off;
    resolver_timeout 5s;
    
    lua_package_path "/usr/local/openresty/nginx/lua/?.lua;/usr/local/openresty/lualib/?.lua;;";
    
    # Shared memory dictionaries
    lua_shared_dict jwt_tokens 10m;  # JWT token validation cache
    lua_shared_dict stats 10m;       # Prometheus metrics
    
    # Request body settings
    client_body_buffer_size 10M;
    client_max_body_size 10M;
    
    # Logging
    access_log /dev/stdout;
    error_log /dev/stderr info;
    
    # Initialize auth configuration
    init_worker_by_lua_block {
        local auth_config = require("auth.auth_config")
        auth_config.init()
    }
    
    server {
        listen 8080;
        
        # Include Prometheus metrics
        include metrics.conf;
        
        # Auth endpoints - no authentication required
        location /auth/ {
            # CORS headers
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-Requested-With' always;
            add_header 'Access-Control-Max-Age' '3600' always;
            
            # Handle preflight requests
            if ($request_method = 'OPTIONS') {
                return 204;
            }
            
            set_by_lua_block $go_auth_service_url {
                local auth_config = require("auth.auth_config")
                return auth_config.get_go_auth_service_url()
            }
            
            proxy_pass $go_auth_service_url;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Internal auth endpoint for JWT token validation
        location = /_auth_token {
            internal;
            content_by_lua_file lua/auth/auth_token_validator.lua;
        }
        
        # Internal endpoint for Go service validation (called by Lua)
        location = /_auth_go_verify {
            internal;
            set_by_lua_block $go_auth_service_url {
                local auth_config = require("auth.auth_config")
                return auth_config.get_go_auth_service_url()
            }
            
            proxy_pass $go_auth_service_url/auth/verify?$args;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header Authorization $http_authorization;
        }
        
        # Health check - no auth
        location /health {
            # CORS headers
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-Requested-With' always;
            add_header 'Access-Control-Max-Age' '3600' always;
            
            # Handle preflight requests
            if ($request_method = 'OPTIONS') {
                return 204;
            }
            
            proxy_pass http://unix:/tmp/nft-proxy.sock:/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        # NFT proxy metrics endpoint
        location /metrics/nft {
            allow 172.16.0.0/12; allow 10.0.0.0/8; allow 127.0.0.1; deny all;
            access_log off;
            proxy_pass http://unix:/tmp/nft-proxy.sock:/metrics;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        # Main NFT API endpoints with hybrid authentication
        location / {
            # CORS headers
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-Requested-With' always;
            add_header 'Access-Control-Max-Age' '3600' always;
            
            # Handle preflight requests
            if ($request_method = 'OPTIONS') {
                return 204;
            }
            
            # Hybrid authentication: satisfy either basic auth OR JWT token
            satisfy any;
            
            # 1) Basic Auth - .htpasswd
            auth_basic           "NFT API";
            auth_basic_user_file /etc/nginx/.htpasswd;
            
            # 2) Auth Request - JWT token
            auth_request         /_auth_token;
            
            # Remove WWW-Authenticate header to prevent browser popup
            header_filter_by_lua_block {
                if ngx.status == 401 then
                    ngx.header["WWW-Authenticate"] = nil
                end
            }
            
            # Proxy to nft-proxy Go service via Unix socket
            proxy_pass http://unix:/tmp/nft-proxy.sock:/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
    }
}
