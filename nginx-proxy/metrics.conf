# metrics.conf
# Prometheus metrics configuration

# Track status codes for all requests
log_by_lua_block {
    local stats = ngx.shared.stats
    local status = tonumber(ngx.var.status)
    
    if status >= 200 and status < 300 then
        stats:incr("requests_2xx", 1, 0)
    elseif status >= 300 and status < 400 then
        stats:incr("requests_3xx", 1, 0)
    elseif status >= 400 and status < 500 then
        stats:incr("requests_4xx", 1, 0)
    elseif status >= 500 then
        stats:incr("requests_5xx", 1, 0)
    end
}

# Internal stub_status for metrics scraping
location = /stub_status {
    internal;
    stub_status;
}

# Prometheus metrics endpoint (combines stub_status + status codes)
location /metrics {
    access_log off;
    
    content_by_lua_block {
        local stats = ngx.shared.stats
        
        -- Read stub_status
        local res = ngx.location.capture("/stub_status")
        
        if res.status == 200 then
            -- Parse stub_status output
            local active = res.body:match("Active connections:%s*(%d+)")
            local accepts, handled, requests = res.body:match("%s*(%d+)%s+(%d+)%s+(%d+)")
            local reading, writing, waiting = res.body:match("Reading:%s*(%d+)%s+Writing:%s*(%d+)%s+Waiting:%s*(%d+)")
            
            -- Output metrics in Prometheus format
            ngx.say("# HELP nginx_connections_accepted Accepted client connections")
            ngx.say("# TYPE nginx_connections_accepted counter")
            ngx.say("nginx_connections_accepted ", accepts or 0)
            
            ngx.say("# HELP nginx_connections_active Active client connections")
            ngx.say("# TYPE nginx_connections_active gauge")
            ngx.say("nginx_connections_active ", active or 0)
            
            ngx.say("# HELP nginx_connections_handled Handled client connections")
            ngx.say("# TYPE nginx_connections_handled counter")
            ngx.say("nginx_connections_handled ", handled or 0)
            
            ngx.say("# HELP nginx_connections_reading Connections where NGINX is reading the request header")
            ngx.say("# TYPE nginx_connections_reading gauge")
            ngx.say("nginx_connections_reading ", reading or 0)
            
            ngx.say("# HELP nginx_connections_waiting Idle client connections")
            ngx.say("# TYPE nginx_connections_waiting gauge")
            ngx.say("nginx_connections_waiting ", waiting or 0)
            
            ngx.say("# HELP nginx_connections_writing Connections where NGINX is writing the response back to the client")
            ngx.say("# TYPE nginx_connections_writing gauge")
            ngx.say("nginx_connections_writing ", writing or 0)
            
            ngx.say("# HELP nginx_http_requests_total Total http requests")
            ngx.say("# TYPE nginx_http_requests_total counter")
            ngx.say("nginx_http_requests_total ", requests or 0)
        end
        
        -- Status code metrics
        ngx.say("# HELP nginx_http_requests_by_status HTTP requests by status code class")
        ngx.say("# TYPE nginx_http_requests_by_status counter")
        ngx.say(string.format('nginx_http_requests_by_status{status="2xx"} %d', 
            stats:get("requests_2xx") or 0))
        ngx.say(string.format('nginx_http_requests_by_status{status="3xx"} %d', 
            stats:get("requests_3xx") or 0))
        ngx.say(string.format('nginx_http_requests_by_status{status="4xx"} %d', 
            stats:get("requests_4xx") or 0))
        ngx.say(string.format('nginx_http_requests_by_status{status="5xx"} %d', 
            stats:get("requests_5xx") or 0))
        
        ngx.say("# HELP nginx_up Status of the last metric scrape")
        ngx.say("# TYPE nginx_up gauge")
        ngx.say("nginx_up 1")
    }
}
